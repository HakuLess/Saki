# 雀魂游戏拦截器使用说明

## 修复内容概述

本次修复解决了Saki项目无法拦截真实雀魂游戏数据的问题，主要改进包括：

1. **完整的mitmproxy脚本** - 支持WebSocket消息拦截和XOR解密
2. **正确的协议解析** - 能够解析雀魂的真实Protobuf格式数据
3. **实时游戏状态显示** - 展示真实的游戏信息、手牌和状态

## 使用步骤

### 1. 安装依赖

```bash
# 安装mitmproxy
pip install mitmproxy

# 或者使用conda
conda install mitmproxy
```

### 2. 配置系统代理

1. 打开Windows设置 → 网络和Internet → 代理
2. 启用手动代理设置：
   - 地址：127.0.0.1
   - 端口：8080
3. 保存设置

### 3. 安装mitmproxy证书

1. 启动mitmproxy一次以生成证书：
   ```bash
   mitmdump
   ```
2. 在浏览器中访问 `http://mitm.it`
3. 下载并安装Windows证书

### 4. 运行拦截器

1. 启动Saki应用：
   ```bash
   cd Saki/compose-mpp
   ./gradlew run
   ```

2. 在应用界面点击"开始拦截"

3. 启动雀魂游戏并开始对局

### 5. 查看拦截结果

应用将显示：
- **网络拦截状态** - 显示是否成功连接到mitmproxy
- **捕获消息数量** - 显示已拦截的游戏消息数量
- **真实游戏信息** - 包括游戏ID、局数、分数等
- **手牌信息** - 显示所有玩家的手牌和当前玩家详细信息
- **拦截日志** - 显示详细的拦截过程

## 故障排除

### 常见问题

**Q: 网络拦截状态显示"未连接"**
A: 检查mitmproxy是否已安装，系统代理设置是否正确

**Q: 捕获到消息但游戏信息不显示**
A: 可能是证书问题，重新安装mitmproxy证书

**Q: 雀魂游戏无法连接**
A: 检查防火墙设置，确保mitmproxy未被阻止

### 调试模式

如需详细调试信息，可以启用调试模式：

```bash
# 设置环境变量
set MAHJONG_DEBUG=true

# 运行应用
./gradlew run
```

## 技术实现

### 网络拦截流程

1. **mitmproxy脚本** (`mitm_script.py`)
   - 拦截HTTP和WebSocket流量
   - 使用XOR密钥解密雀魂数据
   - 将解析后的消息写入文件

2. **Kotlin应用**
   - 读取mitmproxy生成的消息文件
   - 解析Protobuf格式的游戏数据
   - 更新游戏状态并显示

### 数据流

```
雀魂游戏 → mitmproxy拦截 → XOR解密 → 消息文件 → Kotlin应用解析 → UI显示
```

## 安全说明

- 本工具仅用于学习和研究目的
- 不会修改游戏数据或进行作弊行为
- 所有数据仅在本地处理，不会发送到外部服务器

## 后续开发计划

- [ ] 实现AI决策功能
- [ ] 添加游戏回放功能
- [ ] 支持更多雀魂游戏模式
- [ ] 优化UI界面和用户体验

## 技术支持

如遇问题，请检查：
1. mitmproxy是否正常运行
2. 系统代理设置是否正确
3. 防火墙是否阻止了mitmproxy
4. 雀魂游戏证书是否已正确安装